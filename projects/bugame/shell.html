<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>BuGame Web</title>
    <style>
      :root {
        --bg-top: #11344a;
        --bg-bottom: #0a1e2d;
        --panel: rgba(8, 15, 24, 0.62);
        --panel-border: rgba(255, 255, 255, 0.18);
        --text: #f3f5f7;
        --muted: #c4d2de;
        --accent: #ffd166;
      }

      * {
        box-sizing: border-box;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
      }

      body {
        overflow: hidden;
        color: var(--text);
        font-family: "Space Grotesk", "IBM Plex Sans", "Trebuchet MS", sans-serif;
        background:
          radial-gradient(120vw 100vh at 20% 0%, rgba(57, 110, 142, 0.62) 0%, rgba(57, 110, 142, 0) 62%),
          linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
      }

      #stage {
        position: fixed;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }

      #canvas {
        width: auto;
        height: auto;
        max-width: 100vw;
        max-height: 100vh;
        display: block;
        border: 0;
        outline: none;
        background: #000;
        touch-action: none;
      }

      #hud {
        position: fixed;
        top: max(12px, env(safe-area-inset-top));
        left: max(12px, env(safe-area-inset-left));
        right: max(12px, env(safe-area-inset-right));
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        pointer-events: none;
        z-index: 10;
      }

      #status {
        max-width: min(62vw, 560px);
        padding: 10px 14px;
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: var(--panel);
        backdrop-filter: blur(4px);
        color: var(--muted);
        font-size: 14px;
        line-height: 1.25;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #actions {
        pointer-events: auto;
        display: flex;
        gap: 8px;
      }

      .btn {
        border: 1px solid var(--panel-border);
        background: var(--panel);
        color: var(--text);
        border-radius: 10px;
        min-height: 40px;
        padding: 0 12px;
        font: inherit;
        font-size: 13px;
        letter-spacing: 0.02em;
        cursor: pointer;
        transition: transform 120ms ease, border-color 120ms ease, background 120ms ease;
      }

      .btn:hover {
        border-color: rgba(255, 255, 255, 0.35);
        background: rgba(8, 15, 24, 0.78);
      }

      .btn:active {
        transform: translateY(1px);
      }

      #progress-wrap {
        position: fixed;
        left: max(12px, env(safe-area-inset-left));
        right: max(12px, env(safe-area-inset-right));
        bottom: max(12px, env(safe-area-inset-bottom));
        height: 8px;
        border-radius: 999px;
        background: rgba(255, 255, 255, 0.16);
        overflow: hidden;
        z-index: 10;
      }

      #bar {
        height: 100%;
        width: 0%;
        border-radius: inherit;
        background: linear-gradient(90deg, var(--accent), #ffe39a);
        box-shadow: 0 0 18px rgba(255, 209, 102, 0.5);
        transition: width 120ms linear;
      }

      #output {
        position: fixed;
        left: max(12px, env(safe-area-inset-left));
        right: max(12px, env(safe-area-inset-right));
        bottom: calc(max(12px, env(safe-area-inset-bottom)) + 18px);
        height: min(28vh, 180px);
        display: none;
        border: 1px solid var(--panel-border);
        border-radius: 12px;
        background: rgba(5, 10, 16, 0.86);
        color: #8ef58a;
        padding: 10px;
        margin: 0;
        outline: none;
        resize: none;
        font: 12px/1.4 "JetBrains Mono", "Consolas", monospace;
        z-index: 9;
      }

      @media (max-width: 900px) {
        #status {
          max-width: 56vw;
          font-size: 12px;
        }

        .btn {
          min-height: 36px;
          padding: 0 10px;
          font-size: 12px;
        }
      }
    </style>
  </head>
  <body>
    <div id="stage">
      <canvas id="canvas" oncontextmenu="event.preventDefault()" tabindex="-1"></canvas>
    </div>

    <div id="hud">
      <div id="status">Downloading...</div>
      <div id="actions">
        <button id="btn-fs" class="btn" type="button">Fullscreen</button>
        <button id="btn-audio" class="btn" type="button">Audio</button>
        <button id="btn-log" class="btn" type="button">Log</button>
      </div>
    </div>

    <div id="progress-wrap"><div id="bar"></div></div>
    <textarea id="output" rows="8"></textarea>

    <script>
      const statusElement = document.getElementById("status");
      const progressWrap = document.getElementById("progress-wrap");
      const progressBar = document.getElementById("bar");
      const outputElement = document.getElementById("output");
      const audioBtn = document.getElementById("btn-audio");
      const stageElement = document.getElementById("stage");

      const audioContextList = [];
      if (self.AudioContext) {
        self.AudioContext = new Proxy(self.AudioContext, {
          construct(target, args) {
            const result = new target(...args);
            audioContextList.push(result);
            return result;
          },
        });
      }

      function updateAudioButtonLabel() {
        let running = false;
        for (const ctx of audioContextList) {
          if (ctx.state === "running") {
            running = true;
            break;
          }
        }
        audioBtn.textContent = running ? "Audio: On" : "Audio: Off";
      }

      function toggleAudio() {
        let hasSuspended = false;
        for (const ctx of audioContextList) {
          if (ctx.state === "running") {
            ctx.suspend();
            hasSuspended = true;
          }
        }

        if (!hasSuspended) {
          for (const ctx of audioContextList) {
            if (ctx.state === "suspended") ctx.resume();
          }
        }

        updateAudioButtonLabel();
      }

      function fitCanvasToViewport() {
        const canvas = Module.canvas || document.getElementById("canvas");
        if (!canvas) return;

        const viewportW = Math.max(window.innerWidth || 0, document.documentElement.clientWidth || 0);
        const viewportH = Math.max(window.innerHeight || 0, document.documentElement.clientHeight || 0);
        const bufferW = canvas.width || 800;
        const bufferH = canvas.height || 600;

        if (viewportW <= 0 || viewportH <= 0 || bufferW <= 0 || bufferH <= 0) return;

        const scale = Math.min(viewportW / bufferW, viewportH / bufferH);
        const drawW = Math.max(1, Math.floor(bufferW * scale));
        const drawH = Math.max(1, Math.floor(bufferH * scale));

        canvas.style.width = drawW + "px";
        canvas.style.height = drawH + "px";
      }

      function scheduleCanvasFit(frames = 45) {
        let tick = 0;
        const step = () => {
          fitCanvasToViewport();
          tick += 1;
          if (tick < frames) requestAnimationFrame(step);
        };
        step();
      }

      function enterFullscreen() {
        const canvas = Module.canvas || document.getElementById("canvas");
        const target = canvas || stageElement || document.documentElement;
        if (!target) return;

        const request =
          target.requestFullscreen || target.webkitRequestFullscreen || target.msRequestFullscreen;
        if (request) {
          request.call(target);
          setTimeout(() => scheduleCanvasFit(30), 50);
        }
      }

      var Module = {
        preRun: [],
        postRun: [() => scheduleCanvasFit(120)],
        print(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(" ");
          console.log(text);
          outputElement.value += text + "\n";
          outputElement.scrollTop = outputElement.scrollHeight;
        },
        printErr(text) {
          if (arguments.length > 1) text = Array.prototype.slice.call(arguments).join(" ");
          console.error(text);
          outputElement.value += "[ERR] " + text + "\n";
          outputElement.scrollTop = outputElement.scrollHeight;
        },
        canvas: (() => {
          const canvas = document.getElementById("canvas");
          canvas.addEventListener(
            "webglcontextlost",
            (e) => {
              e.preventDefault();
              alert("WebGL context lost. Please reload.");
            },
            false
          );
          return canvas;
        })(),
        setStatus(text) {
          if (!Module.setStatus.last) Module.setStatus.last = { time: Date.now(), text: "" };
          if (text === Module.setStatus.last.text) return;

          const m = text.match(/([^(]+)\((\d+(\.\d+)?)\/(\d+)\)/);
          const now = Date.now();
          if (m && now - Module.setStatus.last.time < 30) return;

          Module.setStatus.last.time = now;
          Module.setStatus.last.text = text;

          if (m) {
            const current = parseInt(m[2], 10);
            const total = parseInt(m[4], 10);
            const pct = total > 0 ? Math.max(0, Math.min(100, (current / total) * 100)) : 0;
            progressBar.style.width = pct.toFixed(2) + "%";
            progressWrap.style.display = "block";
            statusElement.textContent = m[1].trim();
          } else {
            statusElement.textContent = text || "Ready";
            if (!text || text.indexOf("complete") >= 0 || text.indexOf("Ready") >= 0) {
              progressBar.style.width = "100%";
              setTimeout(() => {
                progressWrap.style.display = "none";
              }, 350);
            }
          }
        },
        totalDependencies: 0,
        monitorRunDependencies(left) {
          this.totalDependencies = Math.max(this.totalDependencies, left);
          Module.setStatus(
            left
              ? `Preparing... (${this.totalDependencies - left}/${this.totalDependencies})`
              : "All downloads complete"
          );
          if (left === 0) scheduleCanvasFit(120);
        },
      };

      Module.setStatus("Downloading...");

      window.onerror = function () {
        Module.setStatus("Exception thrown. Check JS console.");
      };

      document.getElementById("btn-fs").addEventListener("click", enterFullscreen);
      document.getElementById("btn-audio").addEventListener("click", toggleAudio);
      document.getElementById("btn-log").addEventListener("click", () => {
        outputElement.style.display = outputElement.style.display === "block" ? "none" : "block";
      });

      window.addEventListener("resize", () => fitCanvasToViewport());
      window.addEventListener("orientationchange", () => scheduleCanvasFit(60));
      document.addEventListener("fullscreenchange", () => scheduleCanvasFit(60));
      if (stageElement && typeof ResizeObserver !== "undefined") {
        const observer = new ResizeObserver(() => fitCanvasToViewport());
        observer.observe(stageElement);
      }

      updateAudioButtonLabel();
      scheduleCanvasFit(60);
    </script>

    {{{ SCRIPT }}}
  </body>
</html>
