// BuLang Benchmark Script
// Usa clock() para medir tempo em segundos

def run_benchmark(name, func, iterations) {
    var start = clock();

    var i = 0;
    while (i < iterations) {
        func();
        i++;
    }

    var end = clock();
    var duration = (end - start) * 1000000;  // microsegundos
    var per_iter = duration / iterations;

    write("[BENCH] {}: {} us ({} iterations, {} us/iter)\n", name, duration, iterations, per_iter);
}

// Teste 1: Incremento simples em loop
def test_simple_increment() {
    var i = 0;
    while (i < 10000) {
        i++;
    }
}

// Teste 2: Multiplas variaveis
def test_multiple_vars() {
    var a = 0; var b = 0; var c = 0; var d = 0; var e = 0;
    var i = 0;
    while (i < 1000) {
        a++; b++; c++; d++; e++;
        i++;
    }
}

// Teste 3: Variaveis locais em funcao
def test_local_function() {
    var sum = 0;
    var i = 0;
    while (i < 1000) {
        var local = i;
        sum = sum + local;
        i++;
    }
    return sum;
}

// Teste 4: Operacoes aritmeticas
def test_arithmetic() {
    var sum = 0;
    var i = 0;
    while (i < 5000) {
        sum = sum + i * 2 - 1;
        i++;
    }
}

// Teste 5: Muitas variaveis
def test_many_vars() {
    var v0=0; var v1=0; var v2=0; var v3=0; var v4=0;
    var v5=0; var v6=0; var v7=0; var v8=0; var v9=0;
    var v10=0; var v11=0; var v12=0; var v13=0; var v14=0;
    var v15=0; var v16=0; var v17=0; var v18=0; var v19=0;
    var v20=0; var v21=0; var v22=0; var v23=0; var v24=0;
    var v25=0; var v26=0; var v27=0; var v28=0; var v29=0;
    var v30=0; var v31=0; var v32=0; var v33=0; var v34=0;
    var v35=0; var v36=0; var v37=0; var v38=0; var v39=0;
    var v40=0; var v41=0; var v42=0; var v43=0; var v44=0;
    var v45=0; var v46=0; var v47=0; var v48=0; var v49=0;

    var i = 0;
    while (i < 100) {
        v0++; v10++; v20++; v30++; v40++;
        i++;
    }
}

// Teste 6: Fibonacci recursivo
def fib(n) {
    if (n <= 1) return n;
    return fib(n - 1) + fib(n - 2);
}

def test_fibonacci() {
    fib(20);
}

// Teste 7: Factorial recursivo
def fact(n) {
    if (n <= 1) return 1;
    return n * fact(n - 1);
}

def test_factorial() {
    fact(15);
}

// Teste 8: Manipulacao de arrays
def test_array() {
    var arr = [];
    var i = 0;
    while (i < 1000) {
        arr.push(i);
        i++;
    }

    var sum = 0;
    i = 0;
    while (i < len(arr)) {
        sum = sum + arr[i];
        i++;
    }
}

// Teste 9: Classes e objetos
class Entity {
    var x = 0.0;
    var y = 0.0;
    var vx = 1.0;
    var vy = 1.0;

    def update() {
        self.x = self.x + self.vx;
        self.y = self.y + self.vy;
    }
}

def test_objects() {
    var entities = [];
    var i = 0;
    while (i < 10) {
        entities.push(Entity());
        i++;
    }

    i = 0;
    while (i < 100) {
        var j = 0;
        while (j < len(entities)) {
            entities[j].update();
            j++;
        }
        i++;
    }
}

// Teste 10: Simulacao de fisica
class Particle {
    var x = 0.0;
    var y = 0.0;
    var vx = 0.0;
    var vy = 0.0;

    def init(px, py) {
        self.x = px;
        self.y = py;
        self.vx = (px - 50.0) / 10.0;
        self.vy = (py - 50.0) / 10.0;
    }

    def update() {
        self.x = self.x + self.vx;
        self.y = self.y + self.vy;
        self.vx = self.vx * 0.99;
        self.vy = self.vy * 0.99;
    }
}

def test_physics() {
    var particles = [];
    var i = 0;
    while (i < 100) {
        var p = Particle(i, i);
        particles.push(p);
        i++;
    }

    var step = 0;
    while (step < 100) {
        i = 0;
        while (i < len(particles)) {
            particles[i].update();
            i++;
        }
        step++;
    }
}

// Teste 11: Nested loops com arrays
def test_nested_loops() {
    var matrix = [];
    var i = 0;
    while (i < 100) {
        var row = [];
        var j = 0;
        while (j < 100) {
            row.push(i * j);
            j++;
        }
        matrix.push(row);
        i++;
    }
}

// Teste 12: Closure com upvalue
def test_closure() {
    def outer() {
        var x = 0;
        def inner() {
            x++;
            return x;
        }
        var i = 0;
        while (i < 1000) {
            inner();
            i++;
        }
        return x;
    }
    outer();
}

// Main
print("========================================");
print("BuLang VM Performance Benchmark");
print("========================================");
print("");

var iterations = 10;

run_benchmark("Simple increment loop (10000 iterations)", test_simple_increment, iterations);
run_benchmark("Multiple variables", test_multiple_vars, iterations);
run_benchmark("Local variables in function", test_local_function, iterations);
run_benchmark("Arithmetic operations", test_arithmetic, iterations);
run_benchmark("Many variables (50)", test_many_vars, iterations);
run_benchmark("Recursive Fibonacci (fib(20))", test_fibonacci, iterations);
run_benchmark("Recursive Factorial (fact(15))", test_factorial, iterations);
run_benchmark("Array manipulation (1000 elements)", test_array, iterations);
run_benchmark("Object property access", test_objects, iterations);
run_benchmark("Physics simulation (100 particles)", test_physics, iterations);
run_benchmark("Nested loops with arrays (100x100)", test_nested_loops, iterations);

print("========================================");
print("Benchmark complete");
print("========================================");

